<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pattern Avoidance - 극한의 반사신경 훈련</title>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4133279395991822" crossorigin="anonymous"></script>
    <style>
        :root { --bg: #0c0c0c; --point: #f1c40f; --danger: #e74c3c; --text: #ffffff; --card: #1a1a1a; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Pretendard', sans-serif; overflow-x: hidden; display: flex; flex-direction: column; align-items: center; }
        header { width: 100%; height: 65px; background: #000; border-bottom: 1px solid #333; display: flex; align-items: center; justify-content: space-between; padding: 0 30px; box-sizing: border-box; position: sticky; top: 0; z-index: 1000; }
        .btn-hub { padding: 10px 20px; background: transparent; color: var(--point); text-decoration: none; font-weight: bold; border: 2px solid var(--point); border-radius: 5px; transition: 0.3s; font-size: 14px; }
        .btn-hub:hover { background: var(--point); color: #000; }
        #game-container { position: relative; width: 100%; min-height: 650px; display: flex; justify-content: center; align-items: center; flex-direction: column; margin-top: 20px; }
        canvas { background: #000; border: 4px solid #fff; display: none; box-shadow: 0 0 25px rgba(255, 255, 255, 0.1); }
        .overlay { text-align: center; background: var(--card); padding: 50px; border-radius: 20px; border: 1px solid #333; min-width: 350px; }
        #start-screen, #result-screen { display: flex; flex-direction: column; align-items: center; gap: 20px; }
        .btn-diff { padding: 12px 30px; font-size: 18px; border: none; cursor: pointer; font-weight: bold; border-radius: 8px; transition: 0.2s; flex: 1; }
        .btn-easy { background: #2ecc71; color: #000; }
        .btn-hard { background: var(--danger); color: #fff; }
        input { padding: 15px; font-size: 18px; border-radius: 8px; border: 1px solid #444; background: #000; color: #fff; width: 250px; text-align: center; margin-bottom: 10px; }
        .btn-main { padding: 15px 60px; font-size: 20px; background: var(--point); border: none; cursor: pointer; font-weight: bold; border-radius: 8px; transition: 0.2s; color: #000; }
        #status-ui { width: 400px; display: none; justify-content: space-between; font-size: 16px; font-weight: bold; margin-bottom: 10px; color: #aaa; }
        #seo-content { width: 90%; max-width: 900px; padding: 60px 0; color: #777; line-height: 1.9; }
        #version-tag { position: fixed; bottom: 10px; right: 10px; font-size: 12px; color: #333; }
    </style>
</head>
<body>

    <header>
        <div style="font-size: 20px; font-weight: 900; letter-spacing: 1px;">PATTERN <span style="color: var(--point);">AVOIDANCE</span></div>
        <a href="https://game-hub-steel-eight.vercel.app/" class="btn-hub">← GAME HUB 돌아가기</a>
    </header>

    <div id="game-container">
        <div id="start-screen" class="overlay">
            <h1 style="font-size: 2.2rem; margin: 0;">난이도 선택 (v1.1.10)</h1>
            <p style="color: #aaa;">플레이어 속도가 2.5로 하향되었습니다. 행운을 빕니다.</p>
            <div style="display:flex; gap:15px; width:100%;">
                <button class="btn-diff btn-easy" onclick="startGame('EASY')">EASY<br><span style="font-size:11px;">HP 15</span></button>
                <button class="btn-diff btn-hard" onclick="startGame('HARD')">HARD<br><span style="font-size:11px;">HP 3 (EXTREME)</span></button>
            </div>
        </div>

        <div id="result-screen" class="overlay" style="display:none;">
            <h2 id="final-status" style="color: var(--danger); margin: 0;">GAME OVER</h2>
            <h1 id="result-time" style="font-size: 3.5rem; color: var(--point); margin: 10px 0;">0.0s</h1>
            <div id="save-form">
                <input type="text" id="username" placeholder="이름 (미입력 시 익명)" maxlength="10">
                <br>
                <button class="btn-main" id="save-btn" onclick="saveRecord()">기록 저장</button>
            </div>
            <button class="btn-main" onclick="location.reload()" style="display:none; background: #333; color: #fff; margin-top: 10px;" id="retry-btn">다시 시도</button>
        </div>

        <div id="status-ui">
            <div id="ui-diff-label">MODE: EASY</div>
            <div style="color:var(--danger)">HP: <span id="hp-val">15</span></div>
            <div id="ui-timer" style="color: var(--point);">0.0s</div>
        </div>
        <canvas id="gameCanvas" width="400" height="400"></canvas>
    </div>

    <section id="seo-content">
        <h3>패턴 피하기 v1.1.10: 신규 패턴 및 밸런스 패치 노트</h3>
        <p>이번 업데이트에서는 플레이어의 이동 속도를 2.5px/f로 하향 조정하여, 단순한 이동이 아닌 정확한 판단과 미세한 조작이 생존의 핵심이 되도록 변경했습니다. 특히 하드 모드에서는 기존보다 2배 이상 빠른 패턴 생성 알고리즘이 적용되어, 인간의 한계를 시험하는 탄막 회피 경험을 제공합니다.</p>
        <p>새롭게 추가된 <b>'호밍 불렛(Homing Bullet)'</b> 패턴은 플레이어의 위치를 실시간으로 추적하여 발사되므로, 멈춰있지 않고 계속해서 움직이는 전략이 필요합니다. 또한 화면 전체를 압박하는 <b>'십자 레이저'</b>와 변칙적인 <b>'복합 레이저'</b> 조합은 사용자의 공간 인지 능력을 극대화시킵니다. 본 훈련을 통해 압박감 속에서도 평정심을 유지하며 최적의 회피 경로를 찾아내는 능력을 길러보세요.</p>
    </section>

    <div id="version-tag">v1.1.10</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCWvmTD7ZqrM8QS2jAtIoxyYw9zDghyyZo",
            authDomain: "dummy-server-ff1b9.firebaseapp.com",
            projectId: "dummy-server-ff1b9",
            storageBucket: "dummy-server-ff1b9.firebasestorage.app",
            messagingSenderId: "275700573811",
            appId: "1:275700573811:web:bb1290a5e5ec97a73cac06"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        let gameState = 'WAIT', diffMode = 'EASY';
        let player = { x: 200, y: 200, r: 6, hp: 15, speed: 2.5 };
        let objects = [], keys = {}, startTime = 0, survivedTime = "0.0";

        window.addEventListener('keydown', (e) => { 
            keys[e.code] = true; 
            if(e.code === 'Escape' && (gameState === 'PLAY' || gameState === 'READY')) endGame(); 
        });
        window.addEventListener('keyup', (e) => { keys[e.code] = false; });

        window.startGame = function(mode) {
            diffMode = mode;
            player.hp = (mode === 'EASY') ? 15 : 3;
            document.getElementById('hp-val').innerText = player.hp;
            document.getElementById('ui-diff-label').innerText = 'MODE: ' + mode;
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('status-ui').style.display = 'flex';
            canvas.style.display = 'block';
            startReady();
        }

        function startReady() {
            gameState = 'READY';
            let count = 3;
            let timer = setInterval(() => {
                if(gameState === 'END') { clearInterval(timer); return; }
                draw();
                ctx.fillStyle = "#f1c40f";
                ctx.font = "bold 50px Pretendard";
                ctx.textAlign = "center";
                ctx.fillText(count > 0 ? count : "START", 200, 220);
                if(count < 0) { clearInterval(timer); gameState = 'PLAY'; startTime = Date.now(); spawnManager(); gameLoop(); }
                count--;
            }, 700);
        }

        function spawnManager() {
            if(gameState !== 'PLAY') return;
            
            const rand = Math.random();
            if(rand < 0.6) spawnLaser(); // 일반 레이저
            else if(rand < 0.85) spawnHoming(); // 추적 탄환
            else spawnCross(); // 십자 레이저

            let base = (diffMode === 'EASY') ? 450 : 250;
            let interval = Math.max((diffMode === 'EASY' ? 200 : 120), base - (parseFloat(survivedTime) * 10));
            setTimeout(spawnManager, interval);
        }

        function spawnLaser() {
            const type = Math.random() > 0.5 ? 'H' : 'V';
            objects.push({ type: 'LASER', sub: type, pos: Math.random()*380+10, stage: 'WARN', timer: Date.now() });
        }

        function spawnHoming() {
            objects.push({ type: 'HOMING', x: Math.random()*400, y: Math.random()*400, tx: player.x, ty: player.y, stage: 'WARN', timer: Date.now() });
        }

        function spawnCross() {
            objects.push({ type: 'LASER', sub: 'H', pos: 200, stage: 'WARN', timer: Date.now(), thick: 40 });
            objects.push({ type: 'LASER', sub: 'V', pos: 200, stage: 'WARN', timer: Date.now(), thick: 40 });
        }

        function update() {
            if(gameState !== 'PLAY') return;
            if(keys['KeyW'] && player.y > player.r) player.y -= player.speed;
            if(keys['KeyS'] && player.y < 400 - player.r) player.y += player.speed;
            if(keys['KeyA'] && player.x > player.r) player.x -= player.speed;
            if(keys['KeyD'] && player.x < 400 - player.r) player.x += player.speed;

            survivedTime = ((Date.now() - startTime) / 1000).toFixed(1);
            document.getElementById('ui-timer').innerText = survivedTime + 's';

            const now = Date.now();
            for(let i = objects.length - 1; i >= 0; i--) {
                let o = objects[i];
                const warnTime = (diffMode === 'EASY') ? 700 : 500;

                if(o.stage === 'WARN' && now - o.timer > warnTime) {
                    o.stage = 'FIRE'; o.timer = now;
                    if(o.type === 'HOMING') { // 발사 시점의 플레이어 방향 계산
                        const angle = Math.atan2(player.y - o.y, player.x - o.x);
                        o.vx = Math.cos(angle) * 6; o.vy = Math.sin(angle) * 6;
                    }
                } else if(o.stage === 'FIRE') {
                    let hit = false;
                    if(o.type === 'LASER') {
                        let t = o.thick || 20;
                        if(o.sub === 'H' && Math.abs(player.y - o.pos) < player.r + t/2) hit = true;
                        if(o.sub === 'V' && Math.abs(player.x - o.pos) < player.r + t/2) hit = true;
                        if(now - o.timer > 200) objects.splice(i, 1);
                    } else if(o.type === 'HOMING') {
                        o.x += o.vx; o.y += o.vy;
                        if(Math.hypot(player.x - o.x, player.y - o.y) < player.r + 5) hit = true;
                        if(o.x < 0 || o.x > 400 || o.y < 0 || o.y > 400) objects.splice(i, 1);
                    }
                    if(hit) { player.hp--; document.getElementById('hp-val').innerText = player.hp; objects.splice(i, 1); if(player.hp <= 0) endGame(); }
                }
            }
        }

        function draw() {
            ctx.fillStyle = "#000"; ctx.fillRect(0,0,400,400);
            // 플레이어
            ctx.beginPath(); ctx.arc(player.x, player.y, player.r, 0, Math.PI*2);
            ctx.fillStyle = "#e74c3c"; ctx.fill(); ctx.closePath();

            objects.forEach(o => {
                ctx.beginPath();
                if(o.type === 'LASER') {
                    if(o.stage === 'WARN') { ctx.strokeStyle = "rgba(241, 196, 15, 0.4)"; ctx.lineWidth = 2; ctx.setLineDash([5,5]); }
                    else { ctx.strokeStyle = "#fff"; ctx.lineWidth = o.thick || 20; ctx.setLineDash([]); }
                    if(o.sub === 'H') { ctx.moveTo(0, o.pos); ctx.lineTo(400, o.pos); }
                    else { ctx.moveTo(o.pos, 0); ctx.lineTo(o.pos, 400); }
                    ctx.stroke();
                } else if(o.type === 'HOMING') {
                    if(o.stage === 'WARN') { 
                        ctx.strokeStyle = "rgba(231, 76, 60, 0.3)"; ctx.lineWidth = 1;
                        ctx.moveTo(o.x, o.y); ctx.lineTo(player.x, player.y); ctx.stroke();
                        ctx.fillStyle = "rgba(231, 76, 60, 0.5)"; ctx.arc(o.x, o.y, 4, 0, Math.PI*2); ctx.fill();
                    } else {
                        ctx.fillStyle = "#f1c40f"; ctx.arc(o.x, o.y, 6, 0, Math.PI*2); ctx.fill();
                    }
                }
            });
        }

        function gameLoop() { if(gameState === 'PLAY') { update(); draw(); requestAnimationFrame(gameLoop); } }

        function endGame() {
            gameState = 'END'; canvas.style.display = 'none';
            document.getElementById('status-ui').style.display = 'none';
            document.getElementById('result-screen').style.display = 'flex';
            document.getElementById('result-time').innerText = survivedTime + 's';
        }

        window.saveRecord = async function() {
            const name = document.getElementById('username').value.trim() || "익명";
            const btn = document.getElementById('save-btn');
            btn.disabled = true; btn.innerText = "저장 중...";
            try {
                await addDoc(collection(db, "avoidance_rankings"), { name, score: parseFloat(survivedTime), difficulty: diffMode, createdAt: serverTimestamp() });
                document.getElementById('save-form').innerHTML = "<b>기록 등록 완료!</b>";
                document.getElementById('retry-btn').style.display = 'block';
            } catch (e) { alert("저장 실패"); btn.disabled = false; }
        }
    </script>
</body>
</html>
