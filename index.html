<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pattern Avoidance - 정교한 컨트롤 훈련</title>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4133279395991822" crossorigin="anonymous"></script>
    <style>
        :root { --bg: #0c0c0c; --point: #f1c40f; --danger: #e74c3c; --text: #ffffff; --card: #1a1a1a; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Pretendard', sans-serif; overflow-x: hidden; display: flex; flex-direction: column; align-items: center; }
        
        header { width: 100%; height: 65px; background: #000; border-bottom: 1px solid #333; display: flex; align-items: center; justify-content: space-between; padding: 0 30px; box-sizing: border-box; position: sticky; top: 0; z-index: 1000; }
        .btn-hub { padding: 10px 20px; background: transparent; color: var(--point); text-decoration: none; font-weight: bold; border: 2px solid var(--point); border-radius: 5px; transition: 0.3s; font-size: 14px; }
        .btn-hub:hover { background: var(--point); color: #000; }

        #game-container { position: relative; width: 100%; min-height: 650px; display: flex; justify-content: center; align-items: center; flex-direction: column; margin-top: 20px; }
        canvas { background: #000; border: 4px solid #fff; display: none; box-shadow: 0 0 25px rgba(255, 255, 255, 0.1); }

        .overlay { text-align: center; background: var(--card); padding: 50px; border-radius: 20px; border: 1px solid #333; min-width: 350px; }
        #start-screen, #result-screen { display: flex; flex-direction: column; align-items: center; gap: 20px; }
        
        .difficulty-container { display: flex; gap: 15px; margin-top: 10px; }
        .btn-diff { padding: 12px 30px; font-size: 18px; border: none; cursor: pointer; font-weight: bold; border-radius: 8px; transition: 0.2s; flex: 1; }
        .btn-easy { background: #2ecc71; color: #000; }
        .btn-hard { background: var(--danger); color: #fff; }
        .btn-diff:hover { opacity: 0.8; transform: scale(1.05); }

        input { padding: 15px; font-size: 18px; border-radius: 8px; border: 1px solid #444; background: #000; color: #fff; width: 250px; text-align: center; margin-bottom: 10px; }
        .btn-main { padding: 15px 60px; font-size: 20px; background: var(--point); border: none; cursor: pointer; font-weight: bold; border-radius: 8px; transition: 0.2s; color: #000; }

        #status-ui { width: 400px; display: none; justify-content: space-between; font-size: 16px; font-weight: bold; margin-bottom: 10px; color: #aaa; }
        .hp-bar { color: var(--danger); font-size: 18px; }

        #seo-content { width: 90%; max-width: 900px; padding: 60px 0; color: #777; line-height: 1.9; }
        h3 { color: var(--point); }
        #version-tag { position: fixed; bottom: 10px; right: 10px; font-size: 12px; color: #333; }
    </style>
</head>
<body>

    <header>
        <div style="font-size: 20px; font-weight: 900; letter-spacing: 1px;">PATTERN <span style="color: var(--point);">AVOIDANCE</span></div>
        <a href="https://game-hub-steel-eight.vercel.app/" class="btn-hub">← GAME HUB 돌아가기</a>
    </header>

    <div id="game-container">
        <div id="start-screen" class="overlay">
            <h1 style="font-size: 2.2rem; margin: 0;">난이도를 선택하세요</h1>
            <p style="color: #aaa; margin-bottom: 10px;">난이도에 따라 체력과 패턴 속도가 다릅니다.</p>
            <div class="difficulty-container">
                <button class="btn-diff btn-easy" onclick="startGame('EASY')">EASY<br><span style="font-size:12px;">HP 15</span></button>
                <button class="btn-diff btn-hard" onclick="startGame('HARD')">HARD<br><span style="font-size:12px;">HP 3</span></button>
            </div>
            <p style="font-size: 14px; color: #555; margin-top: 15px;">조작: WASD | 중단: ESC</p>
        </div>

        <div id="result-screen" class="overlay" style="display:none;">
            <h2 id="final-status" style="color: var(--danger); margin: 0;">GAME OVER</h2>
            <div>
                <p style="margin: 0; color: #888;">생존 기록 (<span id="result-diff"></span>)</p>
                <h1 id="result-time" style="font-size: 3.5rem; color: var(--point); margin: 10px 0;">0.0s</h1>
            </div>
            <div id="save-form">
                <input type="text" id="username" placeholder="이름 (미입력 시 익명)" maxlength="10">
                <br>
                <button class="btn-main" id="save-btn" onclick="saveRecord()">기록 저장하기</button>
            </div>
            <button class="btn-main" id="retry-btn" onclick="location.reload()" style="display:none; background: #333; color: #fff; margin-top: 10px;">다시 시도</button>
        </div>

        <div id="status-ui">
            <div id="ui-diff-label">MODE: EASY</div>
            <div class="hp-bar">HP: <span id="hp-val">15</span></div>
            <div id="ui-timer" style="color: var(--point);">0.0s</div>
        </div>
        <canvas id="gameCanvas" width="400" height="400"></canvas>
    </div>

    <section id="seo-content">
        <div style="background: #111; padding: 25px; border-radius: 10px; border-left: 4px solid var(--point);">
            <h3>난이도별 훈련 가이드: EASY vs HARD</h3>
            <p>패턴 피하기(Pattern Avoidance) 훈련은 플레이어의 수준에 맞춘 단계별 학습을 지원합니다. <b>이지(Easy) 모드</b>는 총 15의 넉넉한 체력을 제공하여 초보자들이 기본적인 레이저 예고 패턴과 이동 메커니즘을 익히기에 적합합니다. 패턴 사이의 간격이 비교적 여유로워 미세 컨트롤의 기초를 다질 수 있습니다.</p>
            <p>반면, <b>하드(Hard) 모드</b>는 단 3의 체력만을 허용하며, 패턴 생성 주기가 매우 조밀하게 설계되어 있습니다. 한 번의 실수가 치명적인 결과로 이어지므로 고도의 집중력과 반사신경이 요구됩니다. 특히 시간이 경과함에 따라 패턴 생성 속도가 가속화되어 사용자의 한계를 시험합니다. 전문적인 게이밍 피지컬 향상을 목표로 한다면 하드 모드에서 30초 이상의 생존 기록을 달성하는 것을 권장합니다.</p>
        </div>
        <div style="margin-top: 30px;">
            <h3>반응 속도 최적화를 위한 알고리즘</h3>
            <p>본 게임은 0.1초 단위의 정밀한 타이머와 실시간 충돌 판정 엔진을 탑재하고 있습니다. 플레이어 캐릭터의 이동 속도는 정밀한 회피가 가능하도록 3.2px/frame으로 밸런싱되었습니다. 이는 너무 빠르지도, 느리지도 않은 속도로 사용자가 정확한 위치 선정을 할 수 있도록 돕습니다. 모든 데이터는 Firebase를 통해 관리되며, 난이도별 독립적인 랭킹 산출을 위한 기초 자료로 활용됩니다. 무작위로 생성되는 가로/세로 레이저의 변칙적 패턴에 대응하며 당신의 인지 능력을 혁신적으로 개선해 보십시오.</p>
        </div>
    </section>

    <div id="version-tag">v1.1.9</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCWvmTD7ZqrM8QS2jAtIoxyYw9zDghyyZo",
            authDomain: "dummy-server-ff1b9.firebaseapp.com",
            projectId: "dummy-server-ff1b9",
            storageBucket: "dummy-server-ff1b9.firebasestorage.app",
            messagingSenderId: "275700573811",
            appId: "1:275700573811:web:bb1290a5e5ec97a73cac06"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        let gameState = 'WAIT';
        let diffMode = 'EASY';
        let player = { x: 200, y: 200, r: 8, hp: 15, speed: 3.2 }; // 이동속도 하향(4 -> 3.2)
        let lasers = [];
        let startTime = 0;
        let survivedTime = "0.0";
        let keys = {};

        window.addEventListener('keydown', (e) => { 
            keys[e.code] = true; 
            if(e.code === 'Escape' && (gameState === 'PLAY' || gameState === 'READY')) endGame(); 
        });
        window.addEventListener('keyup', (e) => { keys[e.code] = false; });

        window.startGame = function(mode) {
            diffMode = mode;
            if(mode === 'EASY') {
                player.hp = 15;
            } else {
                player.hp = 3;
            }
            document.getElementById('hp-val').innerText = player.hp;
            document.getElementById('ui-diff-label').innerText = 'MODE: ' + mode;
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('status-ui').style.display = 'flex';
            canvas.style.display = 'block';
            startReady();
        }

        function startReady() {
            gameState = 'READY';
            let count = 3;
            let timer = setInterval(() => {
                if(gameState === 'END') { clearInterval(timer); return; }
                draw();
                ctx.fillStyle = "#f1c40f";
                ctx.font = "bold 50px Pretendard";
                ctx.textAlign = "center";
                ctx.fillText(count > 0 ? count : "GO!", 200, 220);
                if(count < 0) {
                    clearInterval(timer);
                    gameState = 'PLAY';
                    startTime = Date.now();
                    spawnLaser();
                    gameLoop();
                }
                count--;
            }, 800);
        }

        function spawnLaser() {
            if(gameState !== 'PLAY') return;
            const type = Math.random() > 0.5 ? 'H' : 'V';
            const pos = Math.random() * 360 + 20;
            lasers.push({ type: type, pos: pos, stage: 'WARN', timer: Date.now() });
            
            // 난이도별 다음 패턴 시작 속도 차별화
            let baseInterval = (diffMode === 'EASY') ? 800 : 450;
            let decay = (diffMode === 'EASY') ? 8 : 15;
            let interval = Math.max((diffMode === 'EASY' ? 350 : 180), baseInterval - (parseFloat(survivedTime) * decay));
            
            setTimeout(spawnLaser, interval);
        }

        function update() {
            if(gameState !== 'PLAY') return;
            if(keys['KeyW'] && player.y > player.r) player.y -= player.speed;
            if(keys['KeyS'] && player.y < canvas.height - player.r) player.y += player.speed;
            if(keys['KeyA'] && player.x > player.r) player.x -= player.speed;
            if(keys['KeyD'] && player.x < canvas.width - player.r) player.x += player.speed;

            survivedTime = ((Date.now() - startTime) / 1000).toFixed(1);
            document.getElementById('ui-timer').innerText = survivedTime + 's';

            const now = Date.now();
            for(let i = lasers.length - 1; i >= 0; i--) {
                let l = lasers[i];
                if(l.stage === 'WARN' && now - l.timer > 750) {
                    l.stage = 'FIRE';
                    l.timer = now;
                } else if(l.stage === 'FIRE') {
                    let hit = false;
                    if(l.type === 'H' && Math.abs(player.y - l.pos) < player.r + 10) hit = true;
                    if(l.type === 'V' && Math.abs(player.x - l.pos) < player.r + 10) hit = true;
                    if(hit) {
                        player.hp -= 1;
                        document.getElementById('hp-val').innerText = player.hp;
                        lasers.splice(i, 1);
                        if(player.hp <= 0) endGame();
                        continue;
                    }
                    if(now - l.timer > 200) lasers.splice(i, 1); // 레이저 사라지는 속도는 동일
                }
            }
        }

        function draw() {
            ctx.fillStyle = "#000";
            ctx.fillRect(0,0,400,400);
            ctx.beginPath();
            ctx.arc(player.x, player.y, player.r, 0, Math.PI*2);
            ctx.fillStyle = "#e74c3c";
            ctx.fill();
            ctx.closePath();
            lasers.forEach(l => {
                ctx.beginPath();
                if(l.stage === 'WARN') {
                    ctx.strokeStyle = "rgba(241, 196, 15, 0.4)";
                    ctx.lineWidth = 2;
                    ctx.setLineDash([5, 5]);
                } else {
                    ctx.strokeStyle = "#fff";
                    ctx.lineWidth = 20;
                    ctx.setLineDash([]);
                }
                if(l.type === 'H') { ctx.moveTo(0, l.pos); ctx.lineTo(400, l.pos); }
                else { ctx.moveTo(l.pos, 0); ctx.lineTo(l.pos, 400); }
                ctx.stroke();
            });
        }

        function gameLoop() {
            if(gameState !== 'PLAY') return;
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        function endGame() {
            if(gameState === 'END') return;
            gameState = 'END';
            canvas.style.display = 'none';
            document.getElementById('status-ui').style.display = 'none';
            document.getElementById('result-screen').style.display = 'flex';
            document.getElementById('result-time').innerText = survivedTime + 's';
            document.getElementById('result-diff').innerText = diffMode;
        }

        window.saveRecord = async function() {
            const name = document.getElementById('username').value.trim() || "익명";
            const saveBtn = document.getElementById('save-btn');
            saveBtn.disabled = true;
            saveBtn.innerText = "저장 중...";

            try {
                await addDoc(collection(db, "avoidance_rankings"), {
                    name: name,
                    score: parseFloat(survivedTime),
                    difficulty: diffMode,
                    createdAt: serverTimestamp()
                });
                document.getElementById('save-form').innerHTML = `<p style="color:var(--point); font-weight:bold;">랭킹 등록 완료!</p>`;
                document.getElementById('retry-btn').style.display = 'block';
            } catch (e) {
                console.error(e);
                alert("저장 실패");
                saveBtn.disabled = false;
                saveBtn.innerText = "기록 저장하기";
            }
        }
    </script>
</body>
</html>
