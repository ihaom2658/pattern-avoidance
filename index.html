<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pattern Avoidance - v1.1.34</title>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4133279395991822" crossorigin="anonymous"></script>
    <style>
        :root { --bg: #0c0c0c; --point: #f1c40f; --danger: #e74c3c; --text: #ffffff; --card: #1a1a1a; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Pretendard', sans-serif; overflow-x: hidden; display: flex; flex-direction: column; align-items: center; touch-action: manipulation; }
        .ad-slot-top { width: 100%; max-width: 728px; height: 90px; background: transparent; margin: 5px 0; display: flex; align-items: center; justify-content: center; border: 1px dashed #333; overflow: hidden; }
        header { width: 100%; height: auto; min-height: 70px; background: #000; border-bottom: 1px solid #333; display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; padding: 10px 20px; box-sizing: border-box; position: sticky; top: 0; z-index: 1000; gap: 10px; }
        .bgm-ctrl { display: flex; align-items: center; gap: 8px; background: #222; padding: 5px 12px; border-radius: 20px; border: 1px solid #444; }
        .bgm-ctrl span { font-size: 11px; font-weight: bold; color: var(--point); }
        #volume-slider { width: 60px; accent-color: var(--point); cursor: pointer; }
        .btn-hub { padding: 12px 30px; background: var(--point); color: #000; text-decoration: none; font-weight: 900; border-radius: 8px; font-size: 18px; border: 3px solid #fff; box-shadow: 0 0 15px rgba(241, 196, 15, 0.4); }
        #game-container { position: relative; width: 100%; max-width: 400px; display: flex; justify-content: center; align-items: center; flex-direction: column; margin-top: 5px; }
        canvas { background: #000; border: 3px solid #fff; display: none; width: 100%; aspect-ratio: 1/1; box-shadow: 0 0 25px rgba(255, 255, 255, 0.1); touch-action: none; pointer-events: auto; }
        #mobile-controls { display: none; width: 100%; max-width: 400px; margin-top: 20px; padding-bottom: 20px; z-index: 2000; }
        .d-pad { display: grid; grid-template-columns: repeat(3, 70px); grid-template-rows: repeat(3, 70px); gap: 8px; justify-content: center; }
        .ctrl-btn { width: 70px; height: 70px; background: rgba(255, 255, 255, 0.12); border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 28px; color: #fff; user-select: none; -webkit-user-select: none; }
        .ctrl-btn:active { background: rgba(255, 255, 255, 0.4); border-color: var(--point); }
        .btn-up { grid-column: 2; grid-row: 1; }
        .btn-left { grid-column: 1; grid-row: 2; }
        .btn-right { grid-column: 3; grid-row: 2; }
        .btn-down { grid-column: 2; grid-row: 3; }
        .overlay { text-align: center; background: var(--card); padding: 30px; border-radius: 20px; border: 1px solid #333; width: 90%; box-sizing: border-box; }
        .btn-diff { padding: 15px 0; font-size: 18px; border: none; font-weight: bold; border-radius: 8px; flex: 1; cursor: pointer; }
        .btn-easy { background: #2ecc71; color: #000; }
        .btn-hard { background: var(--danger); color: #fff; }
        .btn-main { padding: 15px 40px; font-size: 18px; background: var(--point); border: none; font-weight: bold; border-radius: 8px; color: #000; cursor: pointer; }
        #status-ui { width: 95%; display: none; justify-content: space-between; font-size: 14px; font-weight: bold; margin-bottom: 8px; }
        #ranking-board { width: 95%; background: var(--card); border-radius: 15px; margin-top: 20px; border: 1px solid #333; overflow: hidden; }
        .rank-tabs { display: flex; background: #222; }
        .rank-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .rank-table td { padding: 12px; border-bottom: 1px solid #222; text-align: center; }
        #seo-section { width: 90%; max-width: 800px; margin-top: 40px; padding-bottom: 80px; color: #ccc; line-height: 1.8; }
        .seo-content-box { background: #111; padding: 30px; border-radius: 15px; border-left: 5px solid var(--point); margin-bottom: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .seo-content-box h2 { color: var(--point); margin-top: 0; font-size: 1.5rem; }
        #version-tag { position: fixed; bottom: 5px; right: 5px; font-size: 10px; color: #444; }
        @media (max-width: 600px) { #mobile-controls { display: block; } }
    </style>
    <script>
        window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
    </script>
    <script defer src="/_vercel/insights/script.js"></script>
    </head>
<body>
    <div class="ad-slot-top"><span style="color:#444; font-size:11px;">ADVERTISEMENT</span></div>
    <header>
        <div style="font-size: 16px; font-weight: 900;">PATTERN <span style="color: var(--point);">AVOIDANCE</span></div>
        <div class="bgm-ctrl">
            <span>BGM</span>
            <input type="range" id="volume-slider" min="0" max="1" step="0.1" value="0.5">
            <button id="bgm-toggle" style="background:none; border:none; color:#fff; cursor:pointer; font-size:12px;">ğŸ”ˆ</button>
        </div>
        <a href="https://game-hub-steel-eight.vercel.app/" class="btn-hub">HUBë¡œ ëŒì•„ê°€ê¸°</a>
    </header>

    <div id="game-container">
        <div id="start-screen" class="overlay">
            <h1 style="font-size: 1.8rem; margin: 0;">ë‚œì´ë„ ì„ íƒ</h1>
            <div style="display:flex; gap:10px; width:100%; margin-top:15px;">
                <button class="btn-diff btn-easy" onclick="startGame('EASY')">EASY</button>
                <button class="btn-diff btn-hard" onclick="startGame('HARD')">HARD</button>
            </div>
            <p style="font-size: 12px; color: #888; margin-top:15px;">ESCë¥¼ ëˆ„ë¥´ë©´ ê²Œì„ì´ ì¢…ë£Œë©ë‹ˆë‹¤.</p>
        </div>
        <div id="result-screen" class="overlay" style="display:none;">
            <h2 style="color: var(--danger); margin: 0;">GAME OVER</h2>
            <h1 id="result-time" style="font-size: 3rem; color: var(--point); margin: 5px 0;">0.0s</h1>
            <div id="save-form">
                <input type="text" id="username" placeholder="ì´ë¦„ ì…ë ¥" maxlength="10" style="padding:12px; border-radius:8px; border:1px solid #444; background:#000; color:#fff; width:160px; text-align:center;">
                <br><br>
                <button class="btn-main" id="save-btn" onclick="saveRecord()">ê¸°ë¡ ì €ì¥</button>
            </div>
            <button class="btn-main" onclick="location.reload()" style="display:none; background: #333; color: #fff; margin-top: 10px;" id="retry-btn">ë‹¤ì‹œ ì‹œë„</button>
        </div>
        <div id="status-ui">
            <div id="ui-diff-label">EASY</div>
            <div style="color:var(--danger)">HP: <span id="hp-val">15</span></div>
            <div id="ui-timer" style="color: var(--point);">0.0s</div>
        </div>
        <canvas id="gameCanvas" width="400" height="400"></canvas>
        <div id="mobile-controls">
            <div class="d-pad">
                <div class="ctrl-btn btn-up" ontouchstart="handleTouch('KeyW', true, event)" ontouchend="handleTouch('KeyW', false, event)">â†‘</div>
                <div class="ctrl-btn btn-left" ontouchstart="handleTouch('KeyA', true, event)" ontouchend="handleTouch('KeyA', false, event)">â†</div>
                <div class="ctrl-btn btn-right" ontouchstart="handleTouch('KeyD', true, event)" ontouchend="handleTouch('KeyD', false, event)">â†’</div>
                <div class="ctrl-btn btn-down" ontouchstart="handleTouch('KeyS', true, event)" ontouchend="handleTouch('KeyS', false, event)">â†“</div>
            </div>
        </div>
        <div id="ranking-board">
            <div class="rank-tabs">
                <button class="rank-tab-btn active" id="tab-easy" onclick="switchRankTab('EASY')">EASY ë­í‚¹</button>
                <button class="rank-tab-btn" id="tab-hard" onclick="switchRankTab('HARD')">HARD ë­í‚¹</button>
            </div>
            <table class="rank-table"><tbody id="rank-list"></tbody></table>
        </div>
    </div>

    <section id="seo-section">
        <div class="seo-content-box">
            <h2>ì¤‘ë…ì„± ê°•í•œ ì›¹ ë¸Œë¼ìš°ì € íƒ„ë§‰ í”¼í•˜ê¸° ê²Œì„</h2>
            <p>íŒ¨í„´ ì–´ë³´ì´ë˜ìŠ¤(Pattern Avoidance)ëŠ” ë³„ë„ì˜ ì„¤ì¹˜ ì—†ì´ ë¸Œë¼ìš°ì €ì—ì„œ ì¦‰ì‹œ ì¦ê¸¸ ìˆ˜ ìˆëŠ” ê³ ë‚œë„ <b>íšŒí”¼ ì•¡ì…˜ ê²Œì„</b>ì…ë‹ˆë‹¤. í˜„ëŒ€ì ì¸ ê°ê°ì˜ UIì™€ í´ë˜ì‹í•œ ì•„ì¼€ì´ë“œ ê°ì„±ì„ ê²°í•©í•˜ì—¬, ë‚¨ë…€ë…¸ì†Œ ëˆ„êµ¬ë‚˜ ë°˜ì‘ ì†ë„ì˜ í•œê³„ì— ë„ì „í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë³¸ ê²Œì„ì€ PC í™˜ê²½ì˜ í‚¤ë³´ë“œ ì¡°ì‘ì€ ë¬¼ë¡ , ìŠ¤ë§ˆíŠ¸í° í™˜ê²½ì˜ í„°ì¹˜ ì¸í„°í˜ì´ìŠ¤ê¹Œì§€ ì™„ë²½í•˜ê²Œ ì§€ì›í•©ë‹ˆë‹¤.</p>
            <h3>í•µì‹¬ ê²Œì„ íŠ¹ì§• ë° í”Œë ˆì´ ë°©ë²•</h3>
            <ul>
                <li><b>ì •ë°€í•œ ë¬¼ë¦¬ ì—”ì§„:</b> ìºë¦­í„°ì˜ ì´ë™ê³¼ íƒ„ë§‰ì˜ ì¶©ëŒ íŒì •ì„ í”½ì…€ ë‹¨ìœ„ë¡œ ê³„ì‚°í•˜ì—¬ ë¶ˆí•©ë¦¬í•œ í”¼ê²© ìƒí™©ì„ ìµœì†Œí™”í–ˆìŠµë‹ˆë‹¤.</li>
                <li><b>ì´ì§€ & í•˜ë“œ ëª¨ë“œ ì œê³µ:</b> 15ì˜ ë„‰ë„‰í•œ ì²´ë ¥ì„ ê°€ì§„ ì´ì§€ ëª¨ë“œì—ì„œ íŒ¨í„´ì„ ìµíˆê³ , ë‹¨ 3íšŒì˜ ê¸°íšŒë§Œ ì£¼ì–´ì§€ëŠ” í•˜ë“œ ëª¨ë“œì—ì„œ ì§„ì •í•œ ê³ ìˆ˜ì— ë„ì „í•˜ì„¸ìš”.</li>
                <li><b>ì—­ë™ì ì¸ íŒ¨í„´ ë³€í™”:</b> ê³ ì •ëœ íŒ¨í„´ì´ ì•„ë‹Œ, ìƒì¡´ ì‹œê°„ì— ë”°ë¼ íƒ„ë§‰ì˜ ì†ë„ì™€ ìƒì„± ë¹ˆë„ê°€ ì‹¤ì‹œê°„ìœ¼ë¡œ ê°€ì†ë˜ì–´ ê¸´ì¥ê°ì„ ìœ ì§€í•©ë‹ˆë‹¤.</li>
            </ul>
        </div>
        <div class="seo-content-box">
            <h2>í•˜ë“œ ëª¨ë“œ ì „ìš©: ë³µí•© ì¤‘ë ¥ì¥ ì‹œìŠ¤í…œ ê°€ì´ë“œ</h2>
            <p>v1.1.34 ë²„ì „ì˜ í•˜ë“œ ëª¨ë“œì—ëŠ” í˜ì‹ ì ì¸ <b>'ì´ì¤‘ ì¤‘ë ¥'</b> ì‹œìŠ¤í…œì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤. ì¤‘ë ¥ì¥ ì›ì˜ ë°”ê¹¥ìª½ì—ì„œëŠ” ì¤‘ì‹¬ë¶€ë¡œ ì„œì„œíˆ ëŒë ¤ê°€ëŠ” í˜ì´ ì‘ìš©í•˜ë©°, ì›ì˜ ì•ˆìª½ìœ¼ë¡œ ì§„ì…í•˜ë©´ ë°˜ëŒ€ë¡œ ë°€ì–´ë‚´ëŠ” í˜ì´ ì‘ìš©í•©ë‹ˆë‹¤. ì´ ë…íŠ¹í•œ ë¬¼ë¦¬ ë²•ì¹™ì€ í”Œë ˆì´ì–´ë¡œ í•˜ì—¬ê¸ˆ ëŠì„ì—†ì´ ìœ„ì¹˜ë¥¼ ìˆ˜ì •í•˜ê²Œ ë§Œë“¤ë©°, ê³ ë„ì˜ ì§‘ì¤‘ë ¥ì„ ìš”êµ¬í•©ë‹ˆë‹¤.</p>
            <h3>ì „ëµì  íšŒí”¼ íŒ</h3>
            <p>ì¤‘ë ¥ì¥ì˜ ì•ˆê³¼ ë°– ê²½ê³„ì—ì„œ í˜ì˜ ê· í˜•ì„ ì´ìš©í•´ ë³´ì„¸ìš”. ë°€ì–´ë‚´ëŠ” í˜ì„ ëš«ê³  ì•ˆìœ¼ë¡œ ë“¤ì–´ê°€ë©´ ì˜¤íˆë ¤ íƒ„ë§‰ìœ¼ë¡œë¶€í„° ì•ˆì „í•œ ê³µê°„ì„ í™•ë³´í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. ìœ ë„íƒ„ê³¼ ë ˆì´ì €ê°€ ë™ì‹œì— ìŸì•„ì§ˆ ë•Œ ì¤‘ë ¥ì˜ ë°©í–¥ì„ ì½ëŠ” ê²ƒì´ ìŠ¹íŒ¨ë¥¼ ê°€ë¦…ë‹ˆë‹¤.</p>
        </div>
        <div class="seo-content-box">
            <h2>ì‹¤ì‹œê°„ ê¸€ë¡œë²Œ ë¦¬ë”ë³´ë“œ ì‹œìŠ¤í…œ</h2>
            <p>êµ¬ê¸€ íŒŒì´ì–´ë² ì´ìŠ¤(Firebase) ë°ì´í„°ë² ì´ìŠ¤ì™€ ì‹¤ì‹œê°„ìœ¼ë¡œ ì—°ë™ë˜ì–´, ê²Œì„ ì¢…ë£Œ ì¦‰ì‹œ ìì‹ ì˜ ê¸°ë¡ì„ ì „ ì„¸ê³„ í”Œë ˆì´ì–´ë“¤ê³¼ ë¹„êµí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. 1ìœ„ë¶€í„° 10ìœ„ê¹Œì§€ì˜ ëª…ì˜ˆì˜ ì „ë‹¹ì— ì´ë¦„ì„ ì˜¬ë ¤ë³´ì„¸ìš”.</p>
            <h3>ì—…ë°ì´íŠ¸ v1.1.34 ê¸°ìˆ ì  ê°œì„ ì‚¬í•­</h3>
            <ul>
                <li><b>ë³µí•© ì¤‘ë ¥ ë¡œì§:</b> ì› ë°–ì—ì„œëŠ” ë‹¹ê¸°ê³  ì› ì•ˆì—ì„œëŠ” ë°€ì–´ë‚´ëŠ” ì •êµí•œ ì¤‘ë ¥ ì‹œìŠ¤í…œì„ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.</li>
                <li><b>ì¡°ì‘ ë°¸ëŸ°ìŠ¤:</b> ì¤‘ë ¥ì˜ ì„¸ê¸°ë¥¼ ì¡°ì ˆí•˜ì—¬ ì‚¬ìš©ìê°€ ì˜ë„ì ìœ¼ë¡œ ì˜ì—­ ì•ˆìœ¼ë¡œ ì§„ì…í•  ìˆ˜ ìˆë„ë¡ ìµœì í™”í–ˆìŠµë‹ˆë‹¤.</li>
                <li><b>ë²„ê·¸ í”½ìŠ¤:</b> íŠ¹ì • í™˜ê²½ì—ì„œ ì¢Œí‘œê°€ ê³ ì •ë˜ë˜ í˜„ìƒì„ ì™„ì „íˆ í•´ê²°í–ˆìŠµë‹ˆë‹¤.</li>
            </ul>
        </div>
    </section>

    <audio id="gameBgm" loop preload="auto"><source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3" type="audio/mpeg"></audio>
    <div id="version-tag">v1.1.34</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, query, serverTimestamp, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        const firebaseConfig = { apiKey: "AIzaSyCWvmTD7ZqrM8QS2jAtIoxyYw9zDghyyZo", authDomain: "dummy-server-ff1b9.firebaseapp.com", projectId: "dummy-server-ff1b9", storageBucket: "dummy-server-ff1b9.firebasestorage.app", messagingSenderId: "275700573811", appId: "1:275700573811:web:bb1290a5e5ec97a73cac06" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app);
        const canvas = document.getElementById('gameCanvas'); const ctx = canvas.getContext('2d');
        const bgm = document.getElementById('gameBgm'); const volSlider = document.getElementById('volume-slider');
        let gameState = 'WAIT', diffMode = 'EASY', animationId = null;
        let player = { x: 200, y: 200, r: 6, hp: 15, speed: 2.3, invul: 0 };
        let objects = [], keys = {}, startTime = 0, survivedTime = "0.0";
        let spawnTimers = [], lastUpdate = 0;

        const savedVol = localStorage.getItem('gameVolume');
        if(savedVol !== null) { bgm.volume = savedVol; volSlider.value = savedVol; } else { bgm.volume = 0.5; }
        volSlider.oninput = (e) => { bgm.volume = e.target.value; localStorage.setItem('gameVolume', e.target.value); };
        document.addEventListener('visibilitychange', () => { if (document.hidden) { bgm.pause(); } else if (gameState !== 'WAIT' && gameState !== 'END') { bgm.play(); } });
        window.onblur = () => { keys = {}; };
        document.body.addEventListener('click', () => { if(bgm.paused && gameState !== 'END') bgm.play(); }, { once: true });
        window.handleTouch = (code, isPressed, event) => { if(event) event.preventDefault(); if(!isPressed) delete keys[code]; else keys[code] = true; };

        async function loadRankings(mode) {
            const list = document.getElementById('rank-list'); list.innerHTML = "<tr><td colspan='3'>ë¡œë”© ì¤‘...</td></tr>";
            try {
                const q = query(collection(db, "avoidance_rankings"), where("difficulty", "==", mode));
                const snap = await getDocs(q); let ranks = []; snap.forEach((doc) => ranks.push(doc.data()));
                ranks.sort((a, b) => b.score - a.score); list.innerHTML = "";
                ranks.slice(0, 10).forEach((data, i) => { list.innerHTML += `<tr><td style="width:50px">${i+1}ìœ„</td><td style="text-align:left;">${data.name||'ìµëª…'}</td><td style="color:var(--point); text-align:right">${(parseFloat(data.score)||0).toFixed(1)}s</td></tr>`; });
            } catch (e) {}
        }
        window.switchRankTab = (mode) => {
            document.getElementById('tab-easy').className = mode === 'EASY' ? 'rank-tab-btn active' : 'rank-tab-btn';
            document.getElementById('tab-hard').className = mode === 'HARD' ? 'rank-tab-btn active' : 'rank-tab-btn';
            loadRankings(mode);
        };
        switchRankTab('EASY');
        window.addEventListener('keydown', (e) => { keys[e.code] = true; if(e.code === 'Escape' && gameState === 'PLAY') endGame(); });
        window.addEventListener('keyup', (e) => { delete keys[e.code]; });

        window.startGame = (mode) => {
            diffMode = mode; player.hp = (mode === 'EASY') ? 15 : 3; player.x = 200; player.y = 200; objects = []; 
            document.getElementById('hp-val').innerText = player.hp; document.getElementById('ui-diff-label').innerText = mode;
            document.getElementById('start-screen').style.display = 'none'; document.getElementById('status-ui').style.display = 'flex';
            canvas.style.display = 'block'; bgm.play(); startReady();
        };

        function startReady() {
            gameState = 'READY'; let count = 3;
            let readyInt = setInterval(() => {
                draw(); ctx.fillStyle = "#f1c40f"; ctx.font = "bold 40px Pretendard"; ctx.textAlign = "center";
                ctx.fillText(count > 0 ? count : "GO!", 200, 215);
                if(count < 0) { clearInterval(readyInt); gameState = 'PLAY'; startTime = Date.now(); lastUpdate = Date.now(); spawnLaserLoop(); spawnHomingLoop(); if(diffMode === 'HARD') spawnHardSpecialLoop(); gameLoop(); }
                count--;
            }, 800);
        }

        function spawnLaserLoop() { if(gameState !== 'PLAY') return; const t = parseFloat(survivedTime); if(t > 40 && Math.random() < 0.3) spawnX(); else if(t > 20 && Math.random() < 0.5) spawnCross(); else spawnLaser(); let base = (diffMode === 'EASY') ? 1000 : 650; spawnTimers.push(setTimeout(spawnLaserLoop, Math.max(200, base - (t * 8)))); }
        function spawnHomingLoop() { if(gameState !== 'PLAY') return; const t = parseFloat(survivedTime); if(t > 45 && Math.random() < 0.4) spawnRadial(); else spawnHoming(); let base = (diffMode === 'EASY') ? 1500 : 900; spawnTimers.push(setTimeout(spawnHomingLoop, Math.max(400, base - (t * 10)))); }
        function spawnHardSpecialLoop() { if(gameState !== 'PLAY') return; objects.push({ type: 'GRAVITY', x: Math.random()*300+50, y: Math.random()*300+50, timer: Date.now(), duration: 6000 }); spawnTimers.push(setTimeout(spawnHardSpecialLoop, 15000)); }
        function spawnLaser() { objects.push({ type: 'LASER', sub: Math.random()>0.5?'H':'V', pos: Math.random()*380+10, stage: 'WARN', timer: Date.now() }); }
        function spawnCross() { objects.push({ type: 'LASER', sub: 'H', pos: player.y, stage: 'WARN', timer: Date.now(), thick: 25 }); objects.push({ type: 'LASER', sub: 'V', pos: player.x, stage: 'WARN', timer: Date.now(), thick: 25 }); }
        function spawnX() { objects.push({ type: 'LASER', sub: 'X1', stage: 'WARN', timer: Date.now() }); objects.push({ type: 'LASER', sub: 'X2', stage: 'WARN', timer: Date.now() }); }
        function spawnHoming() { objects.push({ type: 'HOMING', x: Math.random()*400, y: Math.random()*400, stage: 'WARN', timer: Date.now() }); }
        function spawnRadial() { objects.push({ type: 'RADIAL', x: 200, y: 200, stage: 'FIRE', timer: Date.now() }); }

        function update() {
            const now = Date.now(); const dt = now - lastUpdate; lastUpdate = now;
            if(player.invul > 0) player.invul -= dt;
            let moveX = 0, moveY = 0;
            if(keys['KeyW']) moveY -= player.speed; if(keys['KeyS']) moveY += player.speed;
            if(keys['KeyA']) moveX -= player.speed; if(keys['KeyD']) moveX += player.speed;

            for(let i = objects.length - 1; i >= 0; i--) {
                let o = objects[i];
                if(o.type === 'GRAVITY') {
                    if(now - o.timer > o.duration) { objects.splice(i,1); continue; }
                    const dist = Math.hypot(o.x - player.x, o.y - player.y);
                    const angle = Math.atan2(o.y - player.y, o.x - player.x);
                    
                    if(dist > 100) { 
                        moveX += Math.cos(angle) * 0.45;
                        moveY += Math.sin(angle) * 0.45;
                    } else {
                        moveX -= Math.cos(angle) * 0.65;
                        moveY -= Math.sin(angle) * 0.65;
                    }
                }
            }

            player.x = Math.max(player.r, Math.min(400 - player.r, player.x + moveX));
            player.y = Math.max(player.r, Math.min(400 - player.r, player.y + moveY));
            survivedTime = ((now - startTime) / 1000).toFixed(1);
            document.getElementById('ui-timer').innerText = survivedTime + 's';

            for(let i = objects.length - 1; i >= 0; i--) {
                let o = objects[i]; if(o.type === 'GRAVITY') continue;
                const warnDur = (diffMode === 'EASY') ? 700 : 500;
                if(o.stage === 'WARN' && now - o.timer > warnDur) {
                    o.stage = 'FIRE'; o.timer = now;
                    if(o.type === 'HOMING') { const ang = Math.atan2(player.y - o.y, player.x - o.x); o.vx = Math.cos(ang) * 4.5; o.vy = Math.sin(ang) * 4.5; }
                    if(o.type === 'RADIAL') { o.bullets = []; for(let j=0; j<8; j++){ let a = (Math.PI*2/8)*j; o.bullets.push({x:o.x, y:o.y, vx:Math.cos(a)*3, vy:Math.sin(a)*3}); } }
                } else if(o.stage === 'FIRE') {
                    let hit = false;
                    if(o.type === 'LASER') {
                        let t = o.thick || 15;
                        if(o.sub === 'H' && Math.abs(player.y - o.pos) < player.r + t/2) hit = true;
                        if(o.sub === 'V' && Math.abs(player.x - o.pos) < player.r + t/2) hit = true;
                        if(o.sub === 'X1' && Math.abs(player.x - player.y) < player.r + 10) hit = true;
                        if(o.sub === 'X2' && Math.abs(player.x + player.y - 400) < player.r + 10) hit = true;
                        if(now - o.timer > 200) objects.splice(i, 1);
                    } else if(o.type === 'HOMING') {
                        o.x += o.vx; o.y += o.vy; if(Math.hypot(player.x-o.x, player.y-o.y) < player.r + 5) hit = true;
                        if(o.x<0 || o.x>400 || o.y<0 || o.y>400) objects.splice(i, 1);
                    } else if(o.type === 'RADIAL' && o.bullets) {
                        o.bullets.forEach((b, bi) => { b.x += b.vx; b.y += b.vy; if(Math.hypot(player.x-b.x, player.y-b.y) < player.r + 4) { hit = true; o.bullets.splice(bi, 1); } });
                        if(now - o.timer > 2000) objects.splice(i, 1);
                    }
                    if(hit && player.invul <= 0) { player.hp--; player.invul = 1000; document.getElementById('hp-val').innerText = player.hp; if(player.hp <= 0) endGame(); }
                }
            }
        }

        function draw() {
            ctx.fillStyle = "#000"; ctx.fillRect(0,0,400,400);
            if(!(player.invul > 0 && Math.floor(Date.now()/100) % 2 === 0)) {
                ctx.beginPath(); ctx.arc(player.x, player.y, player.r, 0, Math.PI*2);
                ctx.fillStyle = (player.invul > 0) ? "#3498db" : "#e74c3c"; ctx.fill(); ctx.closePath();
            }
            objects.forEach(o => {
                ctx.beginPath();
                if(o.type === 'GRAVITY') {
                    const pulse = (Math.sin(Date.now()/200) + 1) * 5;
                    ctx.setLineDash([]);
                    ctx.strokeStyle = "rgba(155, 89, 182, 0.6)"; 
                    ctx.lineWidth = 3;
                    ctx.arc(o.x, o.y, 100, 0, Math.PI*2); ctx.stroke();
                    ctx.beginPath();
                    ctx.arc(o.x, o.y, 100 - pulse, 0, Math.PI*2);
                    ctx.strokeStyle = "rgba(155, 89, 182, 0.2)";
                    ctx.stroke();
                } else if(o.type === 'LASER') {
                    if(o.stage === 'WARN') { ctx.strokeStyle = "rgba(241,196,15,0.3)"; ctx.lineWidth = 2; ctx.setLineDash([5,5]); }
                    else { ctx.strokeStyle = "#fff"; ctx.lineWidth = o.thick || 15; ctx.setLineDash([]); }
                    if(o.sub === 'H') { ctx.moveTo(0, o.pos); ctx.lineTo(400, o.pos); }
                    else if(o.sub === 'V') { ctx.moveTo(o.pos, 0); ctx.lineTo(o.pos, 400); }
                    else if(o.sub === 'X1') { ctx.moveTo(0,0); ctx.lineTo(400,400); }
                    else if(o.sub === 'X2') { ctx.moveTo(400,0); ctx.lineTo(0,400); } ctx.stroke();
                } else if(o.type === 'HOMING') {
                    if(o.stage === 'WARN') { ctx.strokeStyle = "rgba(231,76,60,0.6)"; ctx.setLineDash([8,4]); ctx.moveTo(o.x, o.y); ctx.lineTo(player.x, player.y); ctx.stroke(); ctx.fillStyle = "#e74c3c"; ctx.setLineDash([]); ctx.beginPath(); ctx.arc(o.x,o.y,5,0,Math.PI*2); ctx.fill(); }
                    else { ctx.fillStyle = "#f1c40f"; ctx.beginPath(); ctx.arc(o.x,o.y,6,0,Math.PI*2); ctx.fill(); }
                } else if(o.type === 'RADIAL' && o.bullets) { ctx.fillStyle = "#3498db"; o.bullets.forEach(b => { ctx.beginPath(); ctx.arc(b.x,b.y,4,0,Math.PI*2); ctx.fill(); }); }
            });
        }
        function gameLoop() { if(gameState === 'PLAY') { update(); draw(); animationId = requestAnimationFrame(gameLoop); } }
        function endGame() { gameState = 'END'; if(animationId) cancelAnimationFrame(animationId); spawnTimers.forEach(clearTimeout); canvas.style.display = 'none'; document.getElementById('status-ui').style.display = 'none'; document.getElementById('result-screen').style.display = 'flex'; document.getElementById('result-time').innerText = survivedTime + 's'; bgm.pause(); bgm.currentTime = 0; switchRankTab(diffMode); }
        window.saveRecord = async function() {
            const name = document.getElementById('username').value.trim() || "ìµëª…"; const btn = document.getElementById('save-btn'); btn.disabled = true;
            try { await addDoc(collection(db, "avoidance_rankings"), { name, score: Number(survivedTime), difficulty: diffMode, createdAt: serverTimestamp() }); document.getElementById('save-form').innerHTML = "<b style='color:#2ecc71;'>ë“±ë¡ ì™„ë£Œ!</b>"; document.getElementById('retry-btn').style.display = 'block'; loadRankings(diffMode); } catch (e) { alert("ì €ì¥ ì‹¤íŒ¨"); btn.disabled = false; }
        };
    </script>
</body>
</html>
